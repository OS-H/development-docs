# 数字孪生引擎

数字孪生引擎基于云渲染架构，并提供轻量化的 js 的 api 接口给不同业务系统进行使用。

# sdk 引用

纯 HTML 写法:

```
<script src="peer-stream.js"></script>
<video is="peer-stream" id="ws://127.0.0.1:88/"></video>
```

或者使用 JavaScript:

```
<script type="module">
import "peer-stream.js";
const ps = document.createElement("video", { is: "peer-stream" });
ps.id = "ws://127.0.0.1:88/";
document.body.append(ps);
</script>
```

# 收发消息

发送消息:

```
// 若传入对象，会被JSON化
ps.emitMessage(msg: string | object);
```

接收消息:

```
ps.addEventListener("message", e => {
    // JSON.parse(e.detail)
});
```

# 浏览器要求

Google Chrome 90+

# 业务接口

## 生成 POI 点（字体）

```
ps.emitMessage(`
    spawn-POI
    -location="X=18086 Y=1223779 Z=5204"
    -stake="K439+110/-1500"
    -icon=\uE997
    -title=你好，世界
    -color="R=0 G=1 B=.5"
    -shape=1
    -id=poi001
`);

// 飞过去
ps.emitMessage(`
    -to-location="X=18086 Y=1223779 Z=5204"
`);
```

| 参数      | 类型          | 说明                                 |
| --------- | ------------- | ------------------------------------ |
| spawn-POI | void          | 放在首位                             |
| location  | vector3(厘米) | 坐标：三维空间中的 XYZ               |
| stake     | 桩号/车道     | 车道代表横向偏移值，被 location 覆盖 |
| icon      | char          | Unicode 字体图标                     |
| title     | text          | POI 图标旁边展示的标题               |
| color     | vector4       | 主题颜色 RGBA，取值归一化            |
| shape     | +int          | 0 菱形，1 圆形，2 圆角方形           |
| id        | string[]      | 标签数组，空格分隔                   |
| plain     | void          | 简洁模式：纯图标                     |

## 生成动画特效（GIF）

```
ps.emitMessage(`
    spawn-VFX
    -location="X=16772 Y=1264692 Z=5230"
    -stake="K439+110/-1500"
    -scale=.5
    -texture=0
    -period=1.0
    -id="vfx001"
`);

// 飞过去
ps.emitMessage(`
    -to-location="X=16772 Y=1264692 Z=5230"
`);
```

| 参数      | 类型          | 说明                                 |
| --------- | ------------- | ------------------------------------ |
| spawn-VFX | void          | 空                                   |
| location  | vector3(厘米) | XYZ 坐标                             |
| stake     | 桩号/车道     | 车道代表横向偏移值，被 location 覆盖 |
| scale     | float         | 动图缩放比例                         |
| texture   | id            | 选择动图名称                         |
| period    | float(秒)     | 周期：序列帧播放一周的时间           |
| id        | string[]      | 标签数组，空格分隔                   |

## 生成路径

```
ps.emitMessage([
    "spawn-path",
    "points: X=0 Y=0 Z=1500; X=-1000 Y=0 Z=2000; X=0 Y=0 Z=0; X=1000 Y=0 Z=2000; X=0 Y=0 Z=1500",   // cm
    "location: X=15702 Y=1160912 Z=5500", // cm
    "width:100",    // cm
    "material:0",    // int
    "color: R=0 G=1 B=1 A=.5",   // 0~1
    "id:path001",
].join('\r\n'));

```

- 类型：固定字符串“spawn-path”。
- 点集：分号";"分隔的三维坐标，提供一系列点坐标，连接成一段曲线。
- 位置：整体的三维坐标。
- 宽度：路径线条的宽度。
- 材质：选择样式编号。
- 颜色：材质的自定义 RGBA 通道。

## 生成区域围栏

```
ps.emitMessage([
    "spawn-area",
    "points: X=1000 Y=0;  X=-809 Y=588;  X=309 Y=-951;  X=309 Y=951;  X=-809 Y=-588",   // cm
    "location: X=15702 Y=1260912 Z=5200", // cm
    "height:300",    // cm
    "material:0",    // int
    "color: R=0 G=1 B=1 A=.1",   // 0~1
    "id:area001",
].join('\r\n'));

```

- 类型：固定字符串“spawn-area”。
- 坐标：以分号";"分隔的水平坐标 XY，代表二维区域的每个端点。
- 颜色：高亮的颜色（RGBA 通道）。
- 材质：选择区域轮廓的样式编号。
- 高度：“围栏”的高度。
- 位置：三维空间中 XYZ 坐标（需要从经纬海拔转换）。

## 生成模型

```
ps.emitMessage([
    "spawn-mesh",
    "location: X=16772 Y=1269692 Z=5230", // cm
    "scale:1.0",    // float
    "mesh:0",    // int
    "id:mesh001",
].join('\r\n'));

```

- 类型：固定字符串“spawn-mesh”。
- 模型：选择模型编号。
- 位置：三维空间中 XYZ 坐标（需要从经纬海拔转换）。
- 缩放：模型整体的缩放倍数。
- 动画：开发中。

## 飞向目标

```
ps.emitMessage(`
  -to-POI=QingZhouQiao
`)
```

填入目标对象的标签，请参考《内置对象的标签》

## 飞向 XYZ 位置

```
ps.emitMessage(`
    -to-location="X=18086 Y=1220779  Z=5204"
`);
```

传入三维坐标 cm。

## 飞向全桥百分比

输入全桥由西向东的百分比的位置，范围 0-1

```
ps.emitMessage(`
  -to-percent=0.5
`);
```

## 飞向桩号/车道

```
ps.emitMessage(`
  -to-stake=K462+038.546/800
`)
```

- K432+110.000：粤港分界线（最东边）起点。
- K462+038.546：大桥收费站（最西边）终点。
- /0：车道正中央。
- /C：向北或南偏移距离。
- 格式：KA+B/C = 沿桥(1000A+B)米/车道偏移 C 厘米。

## 全桥漫游

```
ps.emitMessage(`
  -travel=1.0
`);
```

- 正数： 向东漫游。
- 负数： 向西漫游。
- 零： 停止。
- 绝对值： 速率倍数。
- 单位速率：30km/90s。

## 请求当前在全桥的位置（百分比）

```
ps.emitMessage("get-location");
```

发送后会返回一个 percent 字段。

## 监听消息

```
ps.addEventListener("message", e=>{
  // JSON.parse(e.detail)
})
```

监听后台三维程序返回的字符串，设置回调函数。

## 隐藏所有非自然物体

```
ps.emitMessage("hideAllPOI");
```

隐藏场景中所有的非自然物体。

## 退出后台三维程序

谨慎操作！

```
ps.emitMessage("exit");
```

## 销毁对象

```
ps.emitMessage(`
  -destroy=tagName
`);
```

输入任意对象的标签

## 修改旋转半径

传入新的旋转半径：100 到 100000 之间，厘米

```
ps.emitMessage(`
  -zoom=1000
`);
```

## 旋转视角

```
ps.emitMessage(`
  -rotate="P=-40.0 Y=-179.999999 R=0"
`);
```

- P：pitch 俯仰角 竖直方向
- Y：yaw 偏航角 水平方向
- R：roll 翻滚角 恒置零

## 《键盘鼠标操作》

| 按键       | 说明                           |
| ---------- | ------------------------------ |
| Esc 退出键 | 切换菜单                       |
| B 键       | 回到初始位置                   |
| 0-9 数字键 | 飞到全桥从西向东 0%-90% 的位置 |
| WSADEQ     | 前后左右上下                   |
| 方向键     | Ctrl+左右键漫游，视野决定速度  |
| 单击       | （非自然物）点击事件           |
| 左键拖拽   | 水平平移                       |
| 右键拖拽   | （第三人称）绕焦点旋转         |
| 中键       | 飞跃，同时返回目标 XYZ 坐标    |
| 滚轮       | 镜头缩放，改变视野             |

## 《内置对象的标签》

bee：Disease_1、Disease_2、Disease_3、Disease_4

camera：8、9、10、11、12、13、14、15、16、17

onSensorClick：
RHS：7416、7417
ULT：7316、7317
VIC：9000、9004
VIB：2060、2062
GPS：12489、12491

其他：T-L6-080201、1、2、3、4、5、6、7

定位：
QingZhouQiao
JiangHaiQiao
JiuZhouQiao
DongFei
XiFei
AnQiaoKouAn
QingBaoBan
GangXiangLiang

## 《返回消息一览》

| JSON 字段 | 类型     | 说明                  |
| --------- | -------- | --------------------- |
| POI       | string[] | POI 点的标签列表      |
| VFX       | string[] | GIF 图的标签列表      |
| percent   | float    | 相机在桥上的百分比    |
| location  | vector3  | 相机在桥上的 XYZ 坐标 |

## 《参数格式》

所有接口参数遵循命令行风格（键值对），且都可以合并，可换行，比如相机的平移旋转缩放可以一并发送。

```
ps.emitMessage(`
  -to-stake=K432+110
  -rotate="P=-40.0 Y=-180 R=0"
  -zoom=500
`);
```

## 《 API 一览》

| 参数         | 类型   | 格式     | 说明               |
| ------------ | ------ | -------- | ------------------ |
| spawn-POI    | {...}  | 键值对   | 创建 POI 点        |
| spawn-VFX    | {...}  | 键值对   | 创建 GIF 动图特效  |
| -to-POI      | name   | 名称     | 定位到非自然对象   |
| -to-location | float3 | XYZ 向量 | 定位到三维坐标     |
| -to-percent  | +float | 归一化   | 定位到全桥线性位置 |
| -to-stake    | id     | 编号     | 定位到桩号/车道    |
| -travel      | float  | 速率     | 全桥漫游速度       |
| get-location | void   | 环回口   | 请求全桥线性位置   |
| hideAllPOI   | void   | 幂等     | 隐藏所有非自然对象 |
| exit         | void   | 幂等     | 退出 3D 程序       |
| -destroy     | name[] | 数组     | 销毁非自然对象     |
| -zoom        | +int   | 厘米     | 视角缩放           |
| -rotate      | float3 | PYR 向量 | 视角旋转           |
