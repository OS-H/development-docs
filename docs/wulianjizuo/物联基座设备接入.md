# 传感器设备接入标准

物联基座为设备接入提供了两类开放 api 接口。
1、将设备属性、数据上传到物联基座
2、物联基座下发控制命令到设备

# 接入标准

设备与物联基座之间通过 MQTT 协议进行消息传递。设备在连接之前需要向物联基座申请访问令牌设备凭证，这些凭证稍后将称为` ACCESS_TOKEN`。设备需要发送用户名值为 `ACCESS_TOKEN` 的 MQTT CONNECT 消息。连接序列期间可能的返回码及其原因：
1、0x00 已连接，已成功连接到首都机场物联网平台 MQTT 服务器。
2、0x04 连接被拒绝，用户名或密码错误。
3、0x05 连接被拒绝，未经授权 。用户名包含无效的 `ACCESS_TOKEN`。

# 数据上传 api

数据上传采用 PUBLISH 消息发送到以下主题：`v1/devices/me/telemetry`

数据上传数据格式采用 json 的键值内容方式。键始终是一个字符串，而值可以是字符串，布尔值，双精度或长整数。示例格式如下：
` ` `{"stringKey":"value1", "booleanKey":true, "doubleKey":42.0, "longKey":73}` ` `

请注意，在这种情况下，服务器端时间戳将分配给上传的数据！如果设备能够获得客户端时间戳，则可以使用以下格式：
`{"ts":1451649600512, "values":{"key1":"value1", "key2":"value2"}}`

在上面的示例中，我们假设“ 1451649600512”是具有毫秒精度的 Unix 时间戳。例如，值'1451649600512'对应于'星期五，2016 年 1 月 1 日 12：00：00.512 GMT'。

通过 mosquitto 工具，将设备遥测数据推送到平台，举例如下：
`mosquitto pub -d -h "127.0.0.1 -t "v1/devices/me/telemetry' -u "$ACCESS_TOKEN' -f "telemetry-data-as-object.json"`

telemetry-data-as-object.json 内容如下
`{"ts":1451649600512,"values": {"key1"."value1”，"key2"."value2"}}`

# 属性上传 api

支持将设备的属性发布到物联基座。属性上传采用 PUBLISH 消息发送到以下主题：`v1/devices/me/attributes`。
通过 mosquitto 工具，将设备属性推送到物联基座，举例如下：
`mosquitto pub -d -h "127.0.0.1 -t "v1/devices/me/attributes' -u "ACCESS_TOKEN' -f "newattributes-values.json"`

newattributes-values.json 的内容如下
`("attribute1":"valuel", "attribute2":true, "attribute3":42.0, "attribute4":73)`

# 下发控制 api

物联基座支持下发控制命令到设备。具体流程如下：
1、设备通过 SUBSCRIBE 消息订阅如下主题`v1/devices/me/rpc/request/+`
2、订阅后，设备会收到一条命令，这个命令将作为以后的主题发布消息：`v1/devices/me/rpc/request/$request_id`
其中`$request_id`是整数类型的请求标识符,物联基座用来区分不同消息的，回复使用相同消息即可。
设备发布响应也需要基于上述主题`v1/devices/me/rpc/response/$request_id`.
以下示例是用 javascript 编写的，基于 mqtt.js。纯命令行示例不可用，因为订阅和发布需要在同一 mqtt 会话中进行。

```var mqtt = require('mqtt')
ACCESS_TOKEN = '1111'
var client = mqtt.connect('mgtt://127.0.0.1', { username: ACCESS_TOKEN })

client.on('connect',function()
{
  console.1og('connected')
  client.subscribe('vl/devices/me/rpc/request/+')
})

client.on('message',function (topic, message) {
  console.1og('request.topic: '+ topic)
  console.1og('request.body: '+ message. toString())
  var requestId = topic.slice('vl/devices/me/rpc/request/'.length)
  client.publish('vl/devices/me/rpc/response/'+ requestId, message)
})

```
